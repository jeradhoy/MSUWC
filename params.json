{"name":"MSUWC","tagline":"","body":"# Intermediate Complexity Catchment-Based Routing Model for LPJ-Guess\r\n\r\n\r\n## Overview\r\nThe purpose of this model is to route surface and subsurface runoff given by the LPJ-Guess DGVM, through a river network created in ArcGIS using the ArcHydro package. The structure of this model consists of a routingFunctions.r file that defines the functions used in routing, and a routeWater.r script in which parameters are configured and the model is excecuted.\r\n\r\nThe functions used in this model are defined below:\r\n\r\n**AggregateRunoff()** - Reads in runoff NetCDFs and aggregates to catchments.\r\n\r\n**RouteWater()** - Routes water through edges.\r\n\r\n**GetGaugeData()** - Finds NWIS river gauges, downloads, and processes data for plotting.\r\n\r\n**GetShapesInBounds()** - Subsetts catchments or edges by HUC code, checks if any upstream polygons are missing, and adds them. The three functions below are used.\r\n\r\n**getParents()** - Returns the two parents of an edge given it's ID.\r\n\r\n**getOrder()** - Returns the order of an edge given it's ID.\r\n\r\n**findAllParents()** - Recursive function, returns all the upstream edges given it's ID.\r\n\r\n**GetShapesById()** - Subsetts catchments or edges by ID. Useful if **GetShapesInBounds()** is not properly subsetting or if are to simulate is smaller than HUC 10.\r\n\r\n**CorrectEdgeSlopes()** - Because many slopes calculated in ArcHydro are negative or zero, this function sets them to a minimum slope value.\r\n\r\n**AssignContribArea()** - Assigns contributing area to edges.\r\n\r\n**AssignBfWidth()** - Assigns width dimensions to edges using equation (6).\r\n\r\n**AssignAcoeff()** - Assigns \"a\" coefficient used in non-linear groundwater discharge relationship given in equation (4).\r\n\r\n**MakeHydrographs()** - Creates hydrographs automatically given flow and gauge data.\r\n\r\n## Running the Model\r\n\r\nTo run the model, clone the repository, start R, and set the working directory to the cloned repository.\r\nDownload the sample data and move the folder into the cloned repo folder.\r\nEnsure you have all the necessary libraries, listed at the top of routeWater.r, installed.\r\nConfigure the parameters in the routeWater.r file to match your data, if not using sample data.\r\nExecute commands in the rest of the routeWater.r file sequentially.\r\n\r\nDownload the shapefiles and data [here.](https://www.dropbox.com/s/q3nh49wmirmm030/Shapefiles.zip?dl=0)\r\n\r\n## Mechanics of Model\r\n\r\nFirst, runoff is aggregated from the NetCDFs using the AggregateRunoff fucntion.\r\nThe NetCDF is converted to a raster brick and aggregated using the **extract()** function and catchment polygons.\r\nA raster pixel is considered to be inside the catchment polygon if the center of the pixel falls within the boundaries of the catchment.\r\nIt may be possible to use the \"weights\" option of **extract()** in order to get only the portion of the raster that the polygon covers if they are not line up exactly.\r\nThis may also make it possible to use other catchment polygons and edges such as the NHD dataset.\r\n\r\nAfter surface and subsurface runoff have been aggregated, the routing can be done. The routing is governed primarily by the following equation (1).\r\n\r\n![eq1] <sub>(1)</sub>\r\n\r\nThe term ![dsdt] represents the change in storage for edges at each timestep.\r\nThis is equal to the inflow of surface runoff, R<sub>s</sub>, plus groundwater discharge, Q<sub>gw</sub>, from stored subsurface runoff, plus inflow from upstream edges, Q<sub>in</sub>, minus edge discharge, Q<sub>out</sub>, and loss to infiltration, irrigation, evaporation, etc., Q<sub>loss</sub>.\r\nQ<sub>loss</sub> is currently set to zero for simplicity.\r\n\r\nQ<sub>out</sub> is governed by equations (2) and (3).\r\nL is the length of a stream reach, in km, v is the velocity of that stream reach at time t, in the same units as L and &Delta;t.\r\nAssuming &Delta;t is 1, and that Q<sub>in</sub> comes in evenly throughout the reach, the term ![1-L/v] gives fraction of water that will leave the reach at each timestep. \r\nAssuming inflows R<sub>s</sub> and Q<sub>gw</sub> are distrubuted evenly throughout the reach and that they too come in evenly througout the day, the fraction that will leave the reach in a timestep is given by ![1-L/2v].\r\nIf ![L/v] is less than 1, all storage in the river, S<sub>riv</sub>, from the previous time step will exit the reach.\r\n\r\n![qOut1] <sub>(2)</sub>\r\n\r\nEquation (2) is stable and conserves mass given that ![L/v <= 1] , but when it isn't, given a very L, or very low velocity, equation (2) is used.\r\nIn this case, the distance water could move in a given timestep is less than the reach length, so none of the Q<sub>in</sub> will exit the reach in a timestep.\r\nThe term ![v/L] gives the fraction of the reach for which ![L/v <= 1] is true, and all of S<sub>riv</sub> in that sement of the reach exits in a given timestep.\r\nUsing the same ![1-L/2v] routing method as above, we find that for the fraction of the reach given by ![v/L] , the L, in this case is equal to v&Delta;t , equating the term to 1.\r\nTherefore, one half of the surface runoff and groundwater discharge entering the reach sub-segment, will exit in a timestep. Above that sub-segment, none will exit.\r\nThis gives us the term ![v/2L] .\r\n \r\n![qOut2] <sub>(3)</sub>\r\n\r\nGroundwater dishcharge is based on a  non-linear storage discharge relationship (Gan and Luo, 2013).\r\nAt each timestep, subsurface runoff is added to groundwater storage, S<sub>gw</sub>, represented in equation (10), and the discharge, Q<sub>gw</sub>, is calculated the following timestep from equation (4).\r\nA is a dimensionless parameter that is currently based off of catchment area, but needs to be calibrated with stream gauges.\r\nIn this case, b has been fixed to .5, giving exponential relationsip between storage and discharge. \r\n\r\n![qGw] <sub>(4)</sub>\r\n\r\n![dSgw/dt]\r\n\r\nAt each timestep, velocity is calculated from the previous timestep's values using a modified Manning's equation.\r\nR is the hydraulic radius given by equation (7). S is the slope, calculated in ArcGis using the ArcHydro toolset. \r\nMannings coefficient, n,  is is set for the entire watershed, and is currently fixed to 0.07.\r\nThis could be calibrated in the future and made variable for each edge.\r\n\r\n![vMann] <sub>(5)</sub>\r\n\r\n\r\nStream dimensions are rectangular, but in the future may be modified to be trapezoidal.\r\nWidth is calculated with an empirical power law function (Li et al., 2013) and calibrated to match observations.\r\nCurrently, a and b are fixed to 0.3, and 0.6, respectively.\r\n\r\n![width] <sub>(6)</sub>\r\n\r\nHeight is calculated using equation (8) from previous timestep's storage and dimensions.\r\nFrom this and width, hydraulic radius is calculated in equation (7) for use in Mannings equation.\r\n\r\n![radius] <sub>(7)</sub>\r\n\r\n![height] <sub>(8)</sub>\r\n\r\nIn the future, flood situations may be included where if heigh exceeds a bankfull height, calculated using an empirical power law equation (9), width will 5 times original width to account for flood plain, and mannings n could be increased.\r\nThis is not currently part of the model.\r\n\r\n![Hbf] <sub>(9)</sub>\r\n\r\n## Generation of ArcHydro Edges and Catchments\r\n\r\nSome details and instructions for generating the arcHydro network are found in NoteBooks/waterCenterNotebook_5-19-2015.ipynb.\r\nWill be cleaned up and added to README.md in the future\r\n\r\n### References\r\nLi HY, Wigmosta MS, Wu H, Huang M, Ke Y, Coleman AM, Leung LR. 2013a. A physically based runoff routing model for land surface and earth system models. Journal of Hydrometeorology 14:808–828.\r\n\r\nGan, R., Luo, Y., 2013. Using the nonlinear aquifer storage–discharge relationship to simulate the baseflow of glacier and snowmelt dominated basins in northwest China. Hydrol. Earth Syst. Sci. 17, 3577–3586. \r\n\r\n## ToDo:\r\n* Add references to readme\r\n* Create function to automatically plot taylor diagrams\r\n* Create function to automatically do GOF analysis\r\n* Clean up archydro generation instructions and include in readme\r\n* Clean up and comment code.\r\n* Create scheme for subnetwork runoff routing\r\n* Create Spinup or calibration functions\r\n* Use weights in extract() function\r\n* Calibrate or define variable n values for each edge\r\n* Make stream dimensions trapezoidal instead of rectangular\r\n* Incorporate flood routing\r\n* Consider parallezing\r\n\r\nNotes:\r\n\r\nTo encode latex:\r\n\\ - %5C\r\n{ - %7B\r\n} - %7D\r\n= - %3D\r\n+ - &plus;\r\n\r\n\r\n[eq1]: https://latex.codecogs.com/gif.latex?%5Cfrac%7B%5Cmathrm%7Bd%7DS%7D%7B%5Cmathrm%7Bd%7Dt%7D%3DR_%7Bs%7D&plus;Q_%7Bgw%7D&plus;Q_%7Bin%7D-Q_%7Bout%7D-Q_%7Bloss%7D\r\n\r\n[dSgw/dt]: https://latex.codecogs.com/gif.latex?%5Cfrac%7B%5Cmathrm%7Bd%7DS_%7Bgw%7D%7D%7B%5Cmathrm%7Bd%7Dt%7D%3DR_%7Bsub%7D-Q_%7Bgw%7D-Q_%7Bgwloss%7D\r\n\r\n[qOut1]: https://latex.codecogs.com/gif.latex?Q_%7Bout1%7D%3DS_%7Briv%7D&plus;(1-%5Cfrac%7BL%7D%7Bv%5CDelta&space;t%7D)%5Csum&space;Q_%7Bin%7D&plus;(1-%5Cfrac%7BL%7D%7B2v%5CDelta&space;t%7D)(R_%7Bs%7D&plus;Q_%7Bgw%7D)\r\n\r\n[qOut2]: https://latex.codecogs.com/gif.latex?Q_%7Bout2%7D%3D%5Cfrac%7Bv%5CDelta&space;t%7D%7BL%7DS_%7Briv%7D&plus;(%5Cfrac%7Bv%5CDelta&space;t%7D%7B2L%7D)(R_%7Bs%7D&plus;Q_%7Bgw%7D)\r\n\r\n[qGw]: https://latex.codecogs.com/gif.latex?Q_%7Bgw%7D%3D(%5Cfrac%7BS_%7Bgw%7D%7D%7Ba%7D)^%7B%5Cfrac%7B1%7D%7Bb%7D%7D \r\n\r\n[vMann]: https://latex.codecogs.com/gif.latex?v%3D%5Cfrac%7BR^%7B%5Cfrac%7B2%7D%7B3%7D%7DS^%7B%5Cfrac%7B1%7D%7B2%7D%7D%7D%7Bn%7D\r\n\r\n[width]: https://latex.codecogs.com/gif.latex?W%3Da(A_%7Btotal%7D)^b\r\n\r\n[radius]: https://latex.codecogs.com/gif.latex%5Cdpi%7B100%7D?R%3D%5Cfrac%7BA%7D%7BP%7D%3D%5Cfrac%7BHW%7D%7B2H&plus;W%7D\r\n\r\n[height]: https://latex.codecogs.com/gif.latex%5Cdpi%7B100%7D?H%3D%5Cfrac%7BS_%7Briv%7D%7D%7BLW%7D\r\n\r\n[Hbf]: https://latex.codecogs.com/gif.latex%5Cdpi%7B100%7D?H_%7Bbf%7D%3Da(A_%7Btotal%7D)^b\r\n\r\n\r\n[dsdt]: https://latex.codecogs.com/gif.latex?%5Cfrac%7B%5Cmathrm%7Bd%7DS%7D%7B%5Cmathrm%7Bd%7Dt%7D\r\n\r\n[1-L/v]: https://latex.codecogs.com/gif.latex?(1-%5Cfrac%7BL%7D%7Bv%5CDelta&space;t%7D)\r\n\r\n[1-L/2v]: https://latex.codecogs.com/gif.latex%5Cdpi%7B100%7D?(1-%5Cfrac%7BL%7D%7B2v%5CDelta&space;t%7D)\r\n\r\n[L/v]: https://latex.codecogs.com/gif.latex%5Cdpi%7B100%7D?%5Cfrac%7BL%7D%7Bv%5CDelta&space;t%7D\r\n\r\n[L/v <= 1]: https://latex.codecogs.com/gif.latex%5Cdpi%7B100%7D?%5Cfrac%7BL%7D%7Bv%5CDelta&space;t%7D&space;%5Cleq&space;1\r\n\r\n[v/L]: https://latex.codecogs.com/gif.latex%5Cdpi%7B100%7D?%5Cfrac%7Bv%5CDelta&space;t%7D%7Bl%7D\r\n\r\n[v/2L]: https://latex.codecogs.com/gif.latex%5Cdpi%7B100%7D?%5Cfrac%7Bv%5CDelta&space;t%7D%7B2L%7D\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}